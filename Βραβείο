import React, { useState, useEffect, useCallback } from 'react';
import { CheckCircle, XCircle, Bike, Car, Walk, Lightbulb, Trophy } from 'lucide-react';

// Define all possible scenarios for the game
const allScenarios = [
  {
    id: 1,
    question: "Θέλεις να περάσεις τον δρόμο. Το φανάρι για τους πεζούς είναι κόκκινο.", // You want to cross the road. The pedestrian light is red.
    image: "https://placehold.co/400x250/ADD8E6/000000?text=Κόκκινο+Φανάρι", // Placeholder for red traffic light
    choices: [
      {
        text: "Περνάω αμέσως, αφού δεν έρχεται κανείς!", // I cross immediately, since no one is coming!
        isCorrect: false,
        feedback: "Ουπς! Το κόκκινο φανάρι σημαίνει «Σταμάτα»! Πρέπει πάντα να περιμένουμε το πράσινο για να περάσουμε με ασφάλεια.", // Oops! The red light means "Stop"! We must always wait for green to cross safely.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!" // Placeholder for danger outcome
      },
      {
        text: "Περιμένω υπομονητικά να γίνει πράσινο.", // I wait patiently for it to turn green.
        isCorrect: true,
        feedback: "Μπράβο! Περιμένοντας το πράσινο φανάρι, είσαι ασφαλής και δίνεις το καλό παράδειγμα!", // Bravo! By waiting for the green light, you are safe and set a good example!
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Διάβαση" // Placeholder for safe outcome
      }
    ]
  },
  {
    id: 2,
    question: "Βρίσκεσαι σε μια διάβαση πεζών χωρίς φανάρι.", // You are at a crosswalk without a traffic light.
    image: "https://placehold.co/400x250/B0C4DE/000000?text=Διάβαση+Πεζών", // Placeholder for crosswalk
    choices: [
      {
        text: "Περνάω τρέχοντας χωρίς να κοιτάξω.", // I run across without looking.
        isCorrect: false,
        feedback: "Προσοχή! Πριν περάσεις, κοίτα πάντα δεξιά-αριστερά-δεξιά, ακόμα και στη διάβαση. Τα αυτοκίνητα μπορεί να μην σε δουν!", // Caution! Before crossing, always look right-left-right, even at the crosswalk. Cars might not see you!
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Σταματάω, κοιτάω δεξιά-αριστερά-δεξιά και μετά περνάω.", // I stop, look right-left-right, and then cross.
        isCorrect: true,
        feedback: "Εξαιρετικά! Έτσι περνάμε με ασφάλεια τη διάβαση. Είσαι ένας έξυπνος πεζός!", // Excellent! That's how we safely cross the crosswalk. You are a smart pedestrian!
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Διάβαση"
      }
    ]
  },
  {
    id: 3,
    question: "Ετοιμάζεσαι να πας βόλτα με το ποδήλατο.", // You are about to go for a bike ride.
    image: "https://placehold.co/400x250/FFFACD/000000?text=Ποδήλατο", // Placeholder for bicycle
    choices: [
      {
        text: "Πάω χωρίς κράνος, είναι άβολο.", // I go without a helmet, it's uncomfortable.
        isCorrect: false,
        feedback: "Το κράνος είναι ο καλύτερός σου φίλος! Σε προστατεύει σε περίπτωση πτώσης. Πάντα να το φοράς!", // The helmet is your best friend! It protects you in case of a fall. Always wear it!
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Φοράω πάντα το κράνος μου σωστά.", // I always wear my helmet correctly.
        isCorrect: true,
        feedback: "Σούπερ! Με το κράνος σου είσαι προστατευμένος και έτοιμος για ασφαλείς βόλτες!", // Super! With your helmet, you are protected and ready for safe rides!
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Ποδηλάτης"
      }
    ]
  },
  {
    id: 4,
    question: "Μπαίνεις στο αυτοκίνητο για μια βόλτα.", // You get in the car for a ride.
    image: "https://placehold.co/400x250/DDA0DD/000000?text=Αυτοκίνητο", // Placeholder for car
    choices: [
      {
        text: "Δεν βάζω ζώνη, αφού είναι μικρή διαδρομή.", // I don't wear a seatbelt, since it's a short trip.
        isCorrect: false,
        feedback: "Η ζώνη ασφαλείας σώζει ζωές! Πρέπει να τη φοράς πάντα, σε κάθε διαδρομή, όσο μικρή κι αν είναι.", // The seatbelt saves lives! You must always wear it, on every trip, no matter how short.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Βάζω πάντα τη ζώνη ασφαλείας μου.", // I always wear my seatbelt.
        isCorrect: true,
        feedback: "Πολύ σωστά! Η ζώνη ασφαλείας είναι απαραίτητη για την προστασία σου στο αυτοκίνητο!", // Very good! The seatbelt is essential for your protection in the car!
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Επιβάτης"
      }
    ]
  },
  {
    id: 5,
    question: "Παίζεις μπάλα και αυτή φεύγει στον δρόμο.", // You are playing ball and it rolls into the street.
    image: "https://placehold.co/400x250/FFD700/000000?text=Μπάλα+στο+Δρόμο", // Placeholder for ball on the road
    choices: [
      {
        text: "Τρέχω αμέσως να την πιάσω.", // I immediately run to get it.
        isCorrect: false,
        feedback: "Ποτέ μην τρέχεις στο δρόμο για ένα παιχνίδι! Ζήτα βοήθεια από έναν ενήλικα ή περίμενε να περάσουν τα αυτοκίνητα.", // Never run into the street for a toy! Ask an adult for help or wait for cars to pass.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Ζητάω βοήθεια από έναν ενήλικα ή περιμένω να περάσουν τα αυτοκίνητα.", // I ask an adult for help or wait for cars to pass.
        isCorrect: true,
        feedback: "Έξυπνη κίνηση! Η ασφάλειά σου είναι πιο σημαντική από οποιοδήποτε παιχνίδι.", // Smart move! Your safety is more important than any toy.
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλές+Παιχνίδι"
      }
    ]
  },
  {
    id: 6,
    question: "Περιμένεις το σχολικό λεωφορείο στη στάση.", // You are waiting for the school bus at the stop.
    image: "https://placehold.co/400x250/F0E68C/000000?text=Σχολικό+Λεωφορείο", // Placeholder for school bus
    choices: [
      {
        text: "Στέκομαι πολύ κοντά στην άκρη του δρόμου.", // I stand very close to the edge of the road.
        isCorrect: false,
        feedback: "Προσοχή! Πρέπει να στέκεσαι πάντα σε ασφαλή απόσταση από την άκρη του δρόμου όταν περιμένεις το λεωφορείο.", // Caution! You must always stand at a safe distance from the edge of the road when waiting for the bus.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Περιμένω στην άκρη του πεζοδρομίου, μακριά από τον δρόμο.", // I wait at the edge of the sidewalk, away from the road.
        isCorrect: true,
        feedback: "Σωστά! Έτσι είσαι ασφαλής και έτοιμος να επιβιβαστείς με ασφάλεια.", // Correct! That way you are safe and ready to board safely.
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Στάση"
      }
    ]
  },
  {
    id: 7,
    question: "Ποδηλατείς το βράδυ.", // You are cycling at night.
    image: "https://placehold.co/400x250/4682B4/FFFFFF?text=Ποδηλασία+Νύχτα", // Placeholder for night cycling
    choices: [
      {
        text: "Δεν χρειάζομαι φώτα, αφού βλέπω καλά.", // I don't need lights, since I can see well.
        isCorrect: false,
        feedback: "Λάθος! Τα φώτα στο ποδήλατο σε κάνουν ορατό στους άλλους οδηγούς και σε προστατεύουν το βράδυ.", // Wrong! Bicycle lights make you visible to other drivers and protect you at night.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Έχω αναμμένα φώτα μπροστά και πίσω και φοράω ανακλαστήρες.", // I have lights on front and back and wear reflectors.
        isCorrect: true,
        feedback: "Μπράβο! Έτσι είσαι ορατός και ασφαλής ακόμα και στο σκοτάδι.", // Bravo! That way you are visible and safe even in the dark.
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ορατός+Ποδηλάτης"
      }
    ]
  },
  {
    id: 8,
    question: "Βγαίνεις από ένα παρκαρισμένο αυτοκίνητο.", // You are getting out of a parked car.
    image: "https://placehold.co/400x250/A9A9A9/000000?text=Παρκαρισμένο+Αυτοκίνητο", // Placeholder for parked car
    choices: [
      {
        text: "Ανοίγω την πόρτα αμέσως και βγαίνω.", // I open the door immediately and get out.
        isCorrect: false,
        feedback: "Προσοχή! Πάντα να κοιτάς για διερχόμενα οχήματα πριν ανοίξεις την πόρτα του αυτοκινήτου.", // Caution! Always look for oncoming vehicles before opening the car door.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Κοιτάω πρώτα στον καθρέφτη και πίσω μου, και μετά ανοίγω την πόρτα προσεκτικά.", // I first look in the mirror and behind me, and then open the door carefully.
        isCorrect: true,
        feedback: "Πολύ σωστά! Έτσι αποφεύγεις ατυχήματα με άλλα οχήματα ή ποδηλάτες.", // Very good! That way you avoid accidents with other vehicles or cyclists.
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Έξοδος"
      }
    ]
  },
  {
    id: 9,
    question: "Βλέπεις ένα φίλο σου στην απέναντι πλευρά του δρόμου.", // You see a friend on the opposite side of the road.
    image: "https://placehold.co/400x250/FFB6C1/000000?text=Φίλος+Απέναντι", // Placeholder for friend across the street
    choices: [
      {
        text: "Τρέχω να τον συναντήσω, αφού δεν έρχεται κανείς.", // I run to meet him, since no one is coming.
        isCorrect: false,
        feedback: "Μην τρέχεις ποτέ στον δρόμο! Πάντα να χρησιμοποιείς τη διάβαση ή το φανάρι και να κοιτάς προσεκτικά.", // Never run into the street! Always use the crosswalk or traffic light and look carefully.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Πηγαίνω στη διάβαση ή στο φανάρι και περνάω με ασφάλεια.", // I go to the crosswalk or traffic light and cross safely.
        isCorrect: true,
        feedback: "Μπράβο! Η ασφάλειά σου είναι η προτεραιότητα.", // Bravo! Your safety is the priority.
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Συνάντηση"
      }
    ]
  },
  {
    id: 10,
    question: "Είσαι επιβάτης σε αυτοκίνητο και ο οδηγός μιλάει στο κινητό.", // You are a passenger in a car and the driver is talking on the phone.
    image: "https://placehold.co/400x250/87CEEB/000000?text=Οδηγός+Κινητό", // Placeholder for driver on phone
    choices: [
      {
        text: "Δεν λέω τίποτα, δεν είναι δική μου δουλειά.", // I don't say anything, it's not my business.
        isCorrect: false,
        feedback: "Είναι σημαντικό να μιλάς για την ασφάλειά σου! Μπορείς να πεις στον οδηγό ότι είναι επικίνδυνο.", // It's important to speak up for your safety! You can tell the driver that it's dangerous.
        outcomeImage: "https://placehold.co/400x250/FF6347/FFFFFF?text=Κίνδυνος!"
      },
      {
        text: "Του ζητάω ευγενικά να κλείσει το κινητό ή να χρησιμοποιήσει hands-free.", // I politely ask him to hang up the phone or use hands-free.
        isCorrect: true,
        feedback: "Πολύ σωστά! Ο οδηγός πρέπει να είναι συγκεντρωμένος στον δρόμο.", // Very good! The driver must be focused on the road.
        outcomeImage: "https://placehold.co/400x250/90EE90/000000?text=Ασφαλής+Οδήγηση"
      }
    ]
  }
];

// Function to shuffle an array
const shuffleArray = (array) => {
  let shuffled = array.slice(); // Create a shallow copy
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

const NUM_QUESTIONS_PER_GAME = 5; // Define how many questions per game

function App() {
  const [shuffledScenarios, setShuffledScenarios] = useState([]);
  const [currentScenarioIndex, setCurrentScenarioIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [showFeedback, setShowFeedback] = useState(false);
  const [feedbackMessage, setFeedbackMessage] = useState('');
  const [isCorrectChoice, setIsCorrectChoice] = useState(false);
  const [outcomeImage, setOutcomeImage] = useState('');
  const [gameEnded, setGameEnded] = useState(false);

  // Function to initialize a new game session
  const initializeGame = useCallback(() => {
    // Shuffle all scenarios and pick the first NUM_QUESTIONS_PER_GAME
    const newShuffledScenarios = shuffleArray(allScenarios).slice(0, NUM_QUESTIONS_PER_GAME);
    setShuffledScenarios(newShuffledScenarios);
    setCurrentScenarioIndex(0);
    setScore(0);
    setShowFeedback(false);
    setGameEnded(false);
  }, []); // No dependencies, so it's created once

  // Initialize game on component mount
  useEffect(() => {
    initializeGame();
  }, [initializeGame]);

  // Handle choice selection
  const handleChoice = (isCorrect, feedback, outcomeImg) => {
    setIsCorrectChoice(isCorrect);
    setFeedbackMessage(feedback);
    setOutcomeImage(outcomeImg);
    if (isCorrect) {
      setScore(score + 1);
    }
    setShowFeedback(true);
  };

  // Move to the next scenario or end the game
  const handleNext = () => {
    setShowFeedback(false);
    if (currentScenarioIndex < shuffledScenarios.length - 1) {
      setCurrentScenarioIndex(currentScenarioIndex + 1);
    } else {
      setGameEnded(true);
    }
  };

  // Restart the game
  const restartGame = () => {
    initializeGame(); // Re-initialize the game with new shuffled scenarios
  };

  // Display the current scenario
  const currentScenario = shuffledScenarios[currentScenarioIndex];

  // Show a loading state if scenarios are not yet loaded (briefly on initial render)
  if (!currentScenario) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center p-4 font-inter">
        <div className="text-2xl text-blue-700">Φορτώνει το παιχνίδι...</div> {/* Loading the game... */}
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center p-4 font-inter">
      <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl text-center border-4 border-blue-400">
        {!gameEnded ? (
          <>
            <h1 className="text-3xl md:text-4xl font-bold text-blue-700 mb-6 flex items-center justify-center gap-2">
              <Lightbulb className="text-yellow-500" size={36} />
              Οδηγός Ασφαλείας: Το Παιχνίδι των Επιλογών!
            </h1>
            <div className="text-lg md:text-xl text-gray-700 mb-4">
              Σενάριο {currentScenarioIndex + 1} / {NUM_QUESTIONS_PER_GAME}
            </div>
            <div className="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-200">
              <img
                src={currentScenario.image}
                alt="Scenario Visual"
                className="w-full h-auto rounded-lg mb-4 object-cover"
                onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/400x250/CCCCCC/000000?text=Εικόνα+Σεναρίου'; }} // Fallback image
              />
              <p className="text-xl md:text-2xl font-semibold text-gray-800">
                {currentScenario.question}
              </p>
            </div>

            <div className="flex flex-col space-y-4">
              {currentScenario.choices.map((choice, index) => (
                <button
                  key={index}
                  onClick={() => handleChoice(choice.isCorrect, choice.feedback, choice.outcomeImage)}
                  disabled={showFeedback}
                  className={`
                    w-full py-3 px-6 rounded-xl text-lg font-semibold transition-all duration-300 ease-in-out
                    ${showFeedback ? 'opacity-60 cursor-not-allowed' : 'hover:scale-105 active:scale-95'}
                    ${choice.isCorrect ? 'bg-green-500 text-white shadow-lg hover:bg-green-600' : 'bg-red-500 text-white shadow-lg hover:bg-red-600'}
                  `}
                >
                  {choice.text}
                </button>
              ))}
            </div>

            {showFeedback && (
              <div className="mt-8 p-6 bg-white rounded-2xl shadow-xl border-4 border-gray-300 animate-fade-in">
                <img
                  src={outcomeImage}
                  alt="Outcome Visual"
                  className="w-full h-48 object-cover rounded-lg mb-4"
                  onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/400x200/CCCCCC/000000?text=Αποτέλεσμα'; }} // Fallback image
                />
                <div className={`text-2xl font-bold mb-3 flex items-center justify-center gap-2 ${isCorrectChoice ? 'text-green-600' : 'text-red-600'}`}>
                  {isCorrectChoice ? (
                    <CheckCircle size={32} className="text-green-500" />
                  ) : (
                    <XCircle size={32} className="text-red-500" />
                  )}
                  {isCorrectChoice ? 'Σωστό!' : 'Λάθος!'}
                </div>
                <p className="text-gray-700 text-lg mb-6 leading-relaxed">
                  {feedbackMessage}
                </p>
                <button
                  onClick={handleNext}
                  className="bg-blue-600 text-white py-3 px-8 rounded-xl text-xl font-bold shadow-lg hover:bg-blue-700 transition-all duration-300 ease-in-out hover:scale-105 active:scale-95"
                >
                  Επόμενο Σενάριο
                </button>
              </div>
            )}
          </>
        ) : (
          <div className="flex flex-col items-center justify-center">
            <Trophy className="text-yellow-500 mb-6" size={80} />
            <h2 className="text-4xl font-bold text-green-700 mb-4">
              Το Παιχνίδι Ολοκληρώθηκε!
            </h2>
            <p className="text-2xl text-gray-800 mb-8">
              Η βαθμολογία σου: <span className="font-extrabold text-blue-600">{score}</span> / {NUM_QUESTIONS_PER_GAME}
            </p>
            {score === NUM_QUESTIONS_PER_GAME && (
              <div className="text-xl md:text-2xl font-bold text-purple-700 mb-6 animate-pulse">
                Συγχαρητήρια! Κέρδισες ένα βραβείο έκπληξη για την άριστη επίδοσή σου!
              </div>
            )}
            <p className="text-lg text-gray-700 mb-8">
              Συνέχισε να είσαι προσεκτικός και ασφαλής στο δρόμο!
            </p>
            <button
              onClick={restartGame}
              className="bg-purple-600 text-white py-3 px-8 rounded-xl text-xl font-bold shadow-lg hover:bg-purple-700 transition-all duration-300 ease-in-out hover:scale-105 active:scale-95"
            >
              Παίξε Ξανά
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

export default App;
